name: Lint Reusable

on:
  workflow_call:
    inputs:
      modules:
        required: true
        type: string
      go-version:
        required: true
        type: string
      golangci-lint-version:
        required: true
        type: string

jobs:
  golangci-lint:
    name: Lint all Go modules
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4.2.2

      - name: üóÑÔ∏è Cache Go modules
        uses: actions/cache@v4.2.0
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum', 'go.work.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: üõ† Set up Go
        uses: actions/setup-go@v5.4.0
        with:
          go-version: ${{ inputs.go-version }}

      - name: üêæ Show go.work (debug)
        run: cat go.work || echo "‚ùó go.work not found"

      - name: üîÑ Install dependencies
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º go work –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
          go work sync

      - name: üìå Install Task
        uses: arduino/setup-task@v2.0.0

      - name: ‚úÖ Run golangci-lint via Taskfile
        id: lint_step
        continue-on-error: true
        env:
          MODULES: ${{ inputs.modules }}
          GOLANGCI_LINT_VERSION: ${{ inputs.golangci-lint-version }}
        run: |
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
          mkdir -p .github_pages/lint
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ª–∏–Ω—Ç–µ—Ä –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          echo "üîç –ó–∞–ø—É—Å–∫ golangci-lint..."
          if task lint > lint_output.txt 2>&1; then
            echo "‚úÖ –õ–∏–Ω—Ç –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ"
            echo "LINT_STATUS=success" >> $GITHUB_OUTPUT
            lint_result="success"
          else
            echo "‚ùå –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ –ª–∏–Ω—Ç–∏–Ω–≥–∞"
            echo "LINT_STATUS=failure" >> $GITHUB_OUTPUT 
            lint_result="failure"
          fi
          
          # –°–æ–∑–¥–∞–µ–º HTML –æ—Ç—á–µ—Ç
          cat > .github_pages/lint/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>üîç Lint Report</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
                      line-height: 1.6;
                      color: #24292f;
                      max-width: 1200px;
                      margin: 0 auto;
                      padding: 20px;
                      background: #ffffff;
                  }
                  .header {
                      text-align: center;
                      padding: 20px 0;
                      border-bottom: 2px solid #e1e4e8;
                      margin-bottom: 30px;
                  }
                  .status-success {
                      background: #dcfce7;
                      color: #15803d;
                      padding: 12px 20px;
                      border-radius: 8px;
                      border: 1px solid #bbf7d0;
                  }
                  .status-failure {
                      background: #fef2f2;
                      color: #dc2626;
                      padding: 12px 20px;
                      border-radius: 8px;
                      border: 1px solid #fecaca;
                  }
                  .report-content {
                      background: #f6f8fa;
                      padding: 20px;
                      border-radius: 8px;
                      border: 1px solid #d1d9e0;
                      font-family: 'SF Mono', Consolas, monospace;
                      white-space: pre-wrap;
                      font-size: 14px;
                      overflow-x: auto;
                  }
                  .info {
                      background: #f0f9ff;
                      color: #0369a1;
                      padding: 12px 20px;
                      border-radius: 8px;
                      border: 1px solid #bae6fd;
                      margin: 20px 0;
                  }
                  .navigation {
                      text-align: center;
                      margin: 30px 0;
                  }
                  .nav-link {
                      display: inline-block;
                      margin: 0 10px;
                      padding: 8px 16px;
                      background: #f6f8fa;
                      color: #24292f;
                      text-decoration: none;
                      border-radius: 6px;
                      border: 1px solid #d1d9e0;
                  }
                  .nav-link:hover {
                      background: #e1e4e8;
                  }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>üîç Lint Report</h1>
          EOF
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ HTML
          if [ "$lint_result" = "success" ]; then
              echo '        <div class="status-success">‚úÖ –õ–∏–Ω—Ç–∏–Ω–≥ –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ - –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>' >> .github_pages/lint/index.html
          else
              echo '        <div class="status-failure">‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –ª–∏–Ω—Ç–∏–Ω–≥–∞</div>' >> .github_pages/lint/index.html
          fi
          
          # –ó–∞–≤–µ—Ä—à–∞–µ–º header –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
          cat >> .github_pages/lint/index.html << 'EOF'
              </div>
          
              <div class="navigation">
                  <a href="../" class="nav-link">üìä Coverage Report</a>
                  <a href="../tests/" class="nav-link">üß™ Test Report</a>
                  <a href="./" class="nav-link">üîç Lint Report</a>
              </div>
          
              <div class="info">
                  <strong>–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω:</strong> 
          EOF
          
          echo "$(date)" >> .github_pages/lint/index.html
          echo '<br><strong>Commit:</strong> ${{ github.sha }}' >> .github_pages/lint/index.html
          echo '<br><strong>Branch:</strong> ${{ github.ref_name }}' >> .github_pages/lint/index.html
          
          cat >> .github_pages/lint/index.html << 'EOF'
              </div>
          
              <h2>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ª–∏–Ω—Ç–∏–Ω–≥–∞:</h2>
              <div class="report-content">
          EOF
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ª–∏–Ω—Ç–∏–Ω–≥–∞ –≤ HTML, —ç–∫—Ä–∞–Ω–∏—Ä—É—è HTML —Å–∏–º–≤–æ–ª—ã
          if [ -f lint_output.txt ]; then
              sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' lint_output.txt >> .github_pages/lint/index.html
          else
              echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ª–∏–Ω—Ç–∏–Ω–≥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã" >> .github_pages/lint/index.html
          fi
          
          cat >> .github_pages/lint/index.html << 'EOF'
              </div>
          </body>
          </html>
          EOF
          
          echo "üìä HTML –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: .github_pages/lint/index.html"

      - name: üì§ Upload lint report artifact
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: |
            .github_pages/lint/
            lint_output.txt
          retention-days: 30

      - name: üìã Show lint summary
        run: |
          echo "üîç Lint Summary:"
          echo "Status: ${{ steps.lint_step.outputs.LINT_STATUS }}"
          if [ -f lint_output.txt ]; then
            echo "üìÑ Output preview (last 10 lines):"
            tail -10 lint_output.txt
          fi